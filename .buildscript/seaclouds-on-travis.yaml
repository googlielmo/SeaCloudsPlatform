name: SeaClouds Platform on TRAVIS
location: travis

services:
- type: org.apache.brooklyn.entity.software.base.SameServerEntity
  name: SeaClouds Deployer + Monitoring + Discoverer
  brooklyn.children:
    - type: seaclouds-discoverer
      setup.latch: $brooklyn:component("deployer").attributeWhenReady("service.isUp")
    - type: seaclouds-deployer
      setup.latch: $brooklyn:component("monitor-manager").attributeWhenReady("service.isUp")
    - type: seaclouds-monitor-manager
      brooklyn.config:
        monitor.dda.host: $brooklyn:component("monitor-dda").attributeWhenReady("host.address")
        monitor.dda.port: $brooklyn:component("monitor-dda").config("monitor.dda.port")
      install.latch: $brooklyn:component("monitor-dda").attributeWhenReady("service.isUp")
    - type: seaclouds-monitor-dda

- type: org.apache.brooklyn.entity.software.base.SameServerEntity
  name: SeaClouds Dashboard + Planner + SLA
  brooklyn.children:
    - type: seaclouds-dashboard
      brooklyn.config:
        deployer.host: $brooklyn:component("deployer").attributeWhenReady("host.address")
        deployer.port: $brooklyn:component("deployer").attributeWhenReady("brooklynnode.webconsole.httpPort")
        sla.host: $brooklyn:component("sla-core").attributeWhenReady("host.address")
        sla.port: $brooklyn:component("sla-core").attributeWhenReady("http.port")
        monitor.manager.host: $brooklyn:component("monitor-manager").attributeWhenReady("host.address")
        monitor.manager.port: $brooklyn:component("monitor-manager").config("monitor.manager.port")
        planner.host: $brooklyn:component("planner").attributeWhenReady("host.address")
        planner.port: $brooklyn:component("planner").config("planner.config.port")
      install.latch: $brooklyn:component("planner").attributeWhenReady("service.isUp")
    - type: seaclouds-planner
      install.latch: $brooklyn:component("sla-core").attributeWhenReady("service.isUp")
    - type: org.apache.brooklyn.entity.webapp.tomcat.TomcatServer
      name: SLA service
      id: sla-core
      brooklyn.config:
        java.sysprops:
            DB_URL: $brooklyn:formatString("jdbc:%s%s", component("sla-db").attributeWhenReady("datastore.url"), "sc_sla")
            DB_USERNAME: "atossla"
            DB_PASSWORD: "_atossla_"
            MONITOR_METRICS_URL: $brooklyn:formatString("http://%s:%s/v1/metrics", component("monitor-manager").attributeWhenReady("host.address"), component("monitor-manager").config("monitor.manager.port"))
            SLA_URL: $brooklyn:formatString("http://%s:%s", component("sla-core").attributeWhenReady("host.address"), component("sla-core").attributeWhenReady("http.port"))
      war: https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=eu.seaclouds-project&a=sla-service&v=LATEST&e=war
      setup.latch: $brooklyn:component("sla-db").attributeWhenReady("service.isUp")

    - type: org.apache.brooklyn.entity.database.mysql.MySqlNode
      name: SLA service Db
      id: sla-db
      brooklyn.config:
        creationScriptUrl: https://raw.githubusercontent.com/SeaCloudsEU/sla-core/e1d3bd4dec27236cfdefa1eae81d38db3dcd11da/sla-repository/src/main/resources/sql/01database.sql
